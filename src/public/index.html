<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiredAlter Network Scanner</title>
    <meta name="description" content="Deep system scan for SSL, HTTP Headers, Open Ports, Carbon Footprint, and Tech Stack.">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .glass-modal { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.1); }
        .search-input { background: rgba(15, 23, 42, 0.8); transition: all 0.2s; }
        .search-input:focus { background: rgba(30, 41, 59, 1); border-color: #3b82f6; outline: none; }
        
        /* Scanner Radar Animation */
        .radar-sweep {
            position: absolute;
            top: 50%; left: 50%;
            width: 100%; height: 100%;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(59, 130, 246, 0.1) 60deg, rgba(59, 130, 246, 0.4) 90deg, transparent 91deg);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: radar-spin 2s linear infinite;
        }
        @keyframes radar-spin { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }

        /* Gauge Circle */
        .circle-chart__circle { animation: circle-chart-fill 1s reverse; transform: rotate(-90deg); transform-origin: center; }
        @keyframes circle-chart-fill { to { stroke-dasharray: 0 100; } }

        /* Custom Scrollbar for Terminal */
        .terminal-scroll::-webkit-scrollbar { width: 6px; }
        .terminal-scroll::-webkit-scrollbar-track { background: #0f172a; }
        .terminal-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>
</head>
<body class="bg-[#0b1120] text-slate-300 min-h-screen flex flex-col">

    <nav class="absolute top-0 left-0 w-full p-6 flex flex-col md:flex-row justify-between items-center z-10 gap-6 md:gap-4">
        <div class="flex flex-col md:flex-row items-center gap-6 w-full md:w-auto">
            <div class="text-2xl font-bold tracking-tight text-white">
                <a href="/">Scan<span class="text-red-500">.</span><span class="text-blue-500">WiredAlter</span></a>
            </div>
            <div class="flex gap-1 bg-slate-800/50 rounded-lg p-1 border border-slate-700/50 backdrop-blur-sm">
                <a href="https://www.wiredalter.com" class="px-4 py-2 md:px-3 md:py-1.5 text-sm font-medium rounded-md text-slate-400 hover:text-white hover:bg-slate-700 transition-all">HOME</a>
                <a href="https://ip.wiredalter.com" class="px-4 py-2 md:px-3 md:py-1.5 text-sm font-medium rounded-md text-slate-400 hover:text-white hover:bg-slate-700 transition-all">IP</a>
                <a href="#" class="px-4 py-2 md:px-3 md:py-1.5 text-sm font-medium rounded-md text-white bg-blue-600 shadow-sm cursor-default">SCAN</a>
                <a href="https://dns.wiredalter.com" class="px-4 py-2 md:px-3 md:py-1.5 text-sm font-medium rounded-md text-slate-400 hover:text-white hover:bg-slate-700 transition-all">DNS</a>
            </div>
        </div>
        <div class="hidden md:flex gap-4 text-sm text-slate-500 font-medium">
            <a href="#faq" class="hover:text-slate-300 transition-colors">FAQ</a>
            <span class="text-slate-700">|</span>
            <a href="https://github.com/wiredalter" class="hover:text-slate-300 transition-colors">GitHub</a>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-44 pb-12 md:py-24 w-full space-y-10">
        
        <div class="text-center space-y-6 max-w-3xl mx-auto">
            <h1 class="text-4xl md:text-5xl font-bold text-white tracking-tight">Deep System Scan</h1>
            <p class="text-slate-400 text-lg">Analyze SSL, Security Headers, Open Ports, Carbon Footprint & Tech Stack.</p>
            
            <div class="relative max-w-lg mx-auto mt-6 flex gap-2">
                <input type="text" id="domainInput" class="block w-full p-4 pl-6 text-sm text-white border border-slate-700 rounded-xl search-input placeholder-slate-500" placeholder="example.com" onkeydown="if(event.key === 'Enter') startScan()">
                <button onclick="startScan()" id="scanBtn" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-xl text-sm px-8 py-2 transition-all shadow-lg shadow-blue-900/20">
                    Scan
                </button>
            </div>
            <p id="errorMsg" class="text-red-400 text-sm hidden"></p>
        </div>

        <div id="loadingSection" class="hidden text-center py-12">
            <div class="inline-flex items-center gap-3 px-4 py-2 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400">
                <span class="relative flex h-3 w-3">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span>
                </span>
                <span class="font-mono text-sm">Initializing Probe & Running Tier 1 Checks...</span>
            </div>
        </div>

        <div id="resultsArea" class="hidden space-y-8 animate-fade-in">
            
            <div class="space-y-4">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    Network & Security (Instant)
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="glass-panel p-6 rounded-xl cursor-pointer hover:bg-slate-800/50 transition-all group relative overflow-hidden" onclick="showModal('sslModal')">
                        <div class="text-blue-400 text-xs font-bold uppercase tracking-wider mb-2">SSL / TLS</div>
                        <div id="sslStatus" class="text-xl font-bold text-white mb-1">...</div>
                        <div id="sslDetail" class="text-sm text-slate-500">Checking...</div>
                        <div class="absolute bottom-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity text-xs text-blue-400 bg-blue-900/30 px-2 py-1 rounded">Details &rarr;</div>
                    </div>

                    <div class="glass-panel p-6 rounded-xl cursor-pointer hover:bg-slate-800/50 transition-all group relative" onclick="showModal('headersModal')">
                        <div class="text-blue-400 text-xs font-bold uppercase tracking-wider mb-2">HTTP Headers</div>
                        <div class="flex items-end gap-2">
                            <div id="headerGrade" class="text-4xl font-bold text-white">...</div>
                            <div id="headerServer" class="text-sm text-slate-500 mb-1.5 font-mono"></div>
                        </div>
                        <div class="absolute bottom-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity text-xs text-blue-400 bg-blue-900/30 px-2 py-1 rounded">Analysis &rarr;</div>
                    </div>

                    <div class="glass-panel p-6 rounded-xl cursor-pointer hover:bg-slate-800/50 transition-all group relative" onclick="showModal('portsModal')">
                        <div class="text-blue-400 text-xs font-bold uppercase tracking-wider mb-2">Open Ports</div>
                        <div id="portsStatus" class="text-lg font-semibold text-white">...</div>
                        <div class="absolute bottom-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity text-xs text-blue-400 bg-blue-900/30 px-2 py-1 rounded">View Ports &rarr;</div>
                    </div>

                    <div class="glass-panel p-6 rounded-xl cursor-pointer hover:bg-slate-800/50 transition-all group relative" onclick="showModal('carbonModal')">
                        <div class="text-blue-400 text-xs font-bold uppercase tracking-wider mb-2">Carbon Footprint</div>
                        <div id="carbonAmount" class="text-xl font-bold text-white">...</div>
                        <div id="carbonGreen" class="text-sm text-slate-500 mt-1">Checking...</div>
                        <div class="absolute bottom-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity text-xs text-blue-400 bg-blue-900/30 px-2 py-1 rounded">Info &rarr;</div>
                    </div>
                </div>
            </div>

            <div id="deepScanSection" class="space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <svg class="w-5 h-5 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></path></svg>
                        Performance & Stack
                    </h3>
                    <div id="deepScanStatus" class="px-2 py-1 rounded text-xs font-bold bg-slate-800 text-slate-400 border border-slate-700">Waiting...</div>
                </div>

                <div id="tier2Loading" class="glass-panel p-0 rounded-xl overflow-hidden flex flex-col md:flex-row h-64 border-l-4 border-blue-500">
                    <div class="w-full md:w-1/3 bg-slate-900/80 p-6 flex flex-col justify-center items-center relative overflow-hidden">
                        <div class="radar-sweep"></div>
                        <div class="relative z-10 text-center space-y-2">
                            <div class="text-4xl">ðŸ“¡</div>
                            <div class="font-mono text-sm text-blue-300 font-bold">DEEP SCAN ACTIVE</div>
                            <div class="text-xs text-slate-500">Headless Chrome Launched</div>
                        </div>
                    </div>
                    <div class="w-full md:w-2/3 bg-[#0f172a] p-4 font-mono text-xs overflow-y-auto terminal-scroll" id="scanTerminal">
                        <div class="text-slate-500 mb-1">$ init wiredalter-scanner --deep</div>
                        <div class="text-blue-400 mb-1">> Spawning Puppeteer Process... [OK]</div>
                        <div class="text-blue-400 mb-1">> Loading DOM Elements...</div>
                    </div>
                </div>

                <div id="tier2Results" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="glass-panel p-6 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-slate-800/50 transition-all" onclick="showModal('perfModal')">
                        <div class="text-slate-400 text-xs font-bold uppercase mb-4">Performance</div>
                        <div id="perfGauge" class="w-24 h-24"></div>
                        <div id="perfScore" class="text-3xl font-bold text-white -mt-16 mb-8">0</div>
                        <div class="text-xs text-blue-400 bg-blue-900/30 px-2 py-1 rounded">What is this?</div>
                    </div>
                    
                    <div class="glass-panel p-6 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:bg-slate-800/50 transition-all" onclick="showModal('seoModal')">
                        <div class="text-slate-400 text-xs font-bold uppercase mb-4">SEO</div>
                        <div id="seoGauge" class="w-24 h-24"></div>
                        <div id="seoScore" class="text-3xl font-bold text-white -mt-16 mb-8">0</div>
                        <div class="text-xs text-blue-400 bg-blue-900/30 px-2 py-1 rounded">What is this?</div>
                    </div>

                    <div class="glass-panel p-6 rounded-xl cursor-pointer hover:bg-slate-800/50 transition-all" onclick="showModal('techModal')">
                        <div class="text-slate-400 text-xs font-bold uppercase mb-4">Tech Stack</div>
                        <div id="techStackList" class="flex flex-wrap gap-2"></div>
                        <div class="mt-4 pt-4 border-t border-slate-700/50">
                            <span class="text-xs text-blue-400">How we detect this &rarr;</span>
                        </div>
                    </div>
                </div>
                
                <div id="screenshotContainer" class="hidden mt-6">
                    <h3 class="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wider">Live Preview</h3>
                    <a id="screenshotLink" href="#" target="_blank" class="block relative group overflow-hidden rounded-xl border border-slate-700/50 shadow-2xl">
                        <img id="screenshotImg" class="w-full transform transition-transform duration-700 group-hover:scale-105 group-hover:opacity-100 opacity-90" src="" alt="Site Screenshot" style="object-fit: cover;">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end justify-center pb-6">
                            <span class="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium text-sm shadow-lg flex items-center gap-2">
                                Visit Website 
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                            </span>
                        </div>
                    </a>
                </div>
            </div>

        </div>

        <div class="border-t border-slate-800/60 pt-10 mt-10">
            <section id="faq" class="max-w-3xl mx-auto px-4 py-16 space-y-12">
                <h3 class="text-2xl font-bold text-center text-white mb-8">Common Questions</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-sm">
                    <div class="space-y-2">
                        <h4 class="font-bold text-blue-400">What is "Deep Scanning"?</h4>
                        <p class="text-slate-400 leading-relaxed">We spawn a headless Google Chrome instance in a secure sandbox to visit your site, run Google Lighthouse audits, and fingerprint technologies using Wappalyzer.</p>
                    </div>
                    <div class="space-y-2">
                        <h4 class="font-bold text-blue-400">Why does it take a few seconds?</h4>
                        <p class="text-slate-400 leading-relaxed">Unlike simple ping tools, we actually load your website's JavaScript and assets to calculate real-world performance metrics.</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="border-t border-slate-800/60 bg-[#0b1120] py-8 text-center text-slate-600 text-sm">
        <div class="space-y-3">
            <p>&copy; <span id="year"></span> WiredAlter Scanner. Powered by Node.js, Puppeteer & BullMQ.</p>
        </div>
    </footer>

    <dialog id="sslModal" class="glass-modal rounded-xl p-0 w-full max-w-lg backdrop:bg-slate-900/80 backdrop:backdrop-blur-sm shadow-2xl">
        <div class="p-6">
            <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2"><svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg> SSL Certificate</h3>
            <div id="sslModalContent" class="space-y-3 text-sm font-mono text-slate-300 border-b border-slate-700 pb-4 mb-4"></div>
            
            <div class="bg-blue-900/20 p-4 rounded-lg border border-blue-500/20 text-sm">
                <h4 class="font-bold text-blue-400 mb-1">Why is this important?</h4>
                <p class="text-slate-400">SSL (Secure Sockets Layer) encrypts the connection between your user and your server. A valid certificate is required for HTTPS. Without it, browsers mark your site as "Not Secure," destroying user trust and SEO rankings.</p>
            </div>
            
            <button onclick="closeModal('sslModal')" class="mt-6 w-full py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg transition-colors">Close</button>
        </div>
    </dialog>

    <dialog id="headersModal" class="glass-modal rounded-xl p-0 w-full max-w-lg backdrop:bg-slate-900/80 backdrop:backdrop-blur-sm shadow-2xl">
        <div class="p-6">
            <h3 class="text-xl font-bold text-white mb-4">HTTP Security Headers</h3>
            <div id="headersModalContent" class="space-y-3 border-b border-slate-700 pb-4 mb-4"></div>
            
            <div class="space-y-3">
                <div class="bg-slate-800/50 p-3 rounded border border-slate-700/50">
                    <span class="text-blue-400 font-bold text-xs block mb-1">CSP (Content Security Policy)</span>
                    <p class="text-slate-400 text-xs">Prevents Cross-Site Scripting (XSS) by explicitly telling the browser which scripts are allowed to run.</p>
                </div>
                <div class="bg-slate-800/50 p-3 rounded border border-slate-700/50">
                    <span class="text-blue-400 font-bold text-xs block mb-1">HSTS (Strict Transport Security)</span>
                    <p class="text-slate-400 text-xs">Forces the browser to ONLY use HTTPS, preventing protocol downgrade attacks.</p>
                </div>
                <div class="bg-slate-800/50 p-3 rounded border border-slate-700/50">
                    <span class="text-blue-400 font-bold text-xs block mb-1">X-Frame-Options</span>
                    <p class="text-slate-400 text-xs">Prevents "Clickjacking" attacks by stopping other sites from embedding yours in an iframe.</p>
                </div>
            </div>
            <button onclick="closeModal('headersModal')" class="mt-6 w-full py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg transition-colors">Close</button>
        </div>
    </dialog>

    <dialog id="portsModal" class="glass-modal rounded-xl p-0 w-full max-w-lg backdrop:bg-slate-900/80 backdrop:backdrop-blur-sm shadow-2xl">
        <div class="p-6">
            <h3 class="text-xl font-bold text-white mb-4">Port Scan Analysis</h3>
            <div id="portsModalContent" class="space-y-2 border-b border-slate-700 pb-4 mb-4"></div>
            
            <div class="bg-blue-900/20 p-4 rounded-lg border border-blue-500/20 text-sm">
                <h4 class="font-bold text-blue-400 mb-1">Understanding Ports</h4>
                <p class="text-slate-400">Open ports are doors into your server. Only ports 80 (HTTP) and 443 (HTTPS) should be open to the public web. Management ports like 22 (SSH) or 21 (FTP) should be firewall-restricted to specific IPs to prevent brute-force hacking.</p>
            </div>
            <button onclick="closeModal('portsModal')" class="mt-6 w-full py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg transition-colors">Close</button>
        </div>
    </dialog>

    <dialog id="carbonModal" class="glass-modal rounded-xl p-0 w-full max-w-lg backdrop:bg-slate-900/80 backdrop:backdrop-blur-sm shadow-2xl">
        <div class="p-6">
            <h3 class="text-xl font-bold text-white mb-4">Digital Carbon Footprint</h3>
            <div id="carbonModalContent" class="space-y-4">
                <p class="text-slate-400 text-sm">We estimate the CO2 produced every time someone visits this page based on data transfer size and energy intensity data.</p>
                <div class="bg-emerald-900/20 p-4 rounded-lg border border-emerald-500/20 text-sm">
                    <h4 class="font-bold text-emerald-400 mb-1">What is Green Hosting?</h4>
                    <p class="text-slate-400">Green hosting means your datacenter uses renewable energy (solar, wind, hydro) or purchases carbon offsets. The Green Web Foundation verifies these providers.</p>
                </div>
            </div>
            <button onclick="closeModal('carbonModal')" class="mt-6 w-full py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg transition-colors">Close</button>
        </div>
    </dialog>

    <dialog id="perfModal" class="glass-modal rounded-xl p-0 w-full max-w-lg backdrop:bg-slate-900/80 backdrop:backdrop-blur-sm shadow-2xl">
        <div class="p-6">
            <h3 class="text-xl font-bold text-white mb-4">Lighthouse Performance</h3>
            <p class="text-slate-400 text-sm mb-4">This score (0-100) reflects how fast your page loads for a real user.</p>
            <div class="space-y-3">
                 <div class="bg-slate-800/50 p-3 rounded border border-slate-700/50">
                    <span class="text-blue-400 font-bold text-xs block mb-1">FCP (First Contentful Paint)</span>
                    <p class="text-slate-400 text-xs">How long it takes for the first text or image to appear.</p>
                </div>
                <div class="bg-slate-800/50 p-3 rounded border border-slate-700/50">
                    <span class="text-blue-400 font-bold text-xs block mb-1">LCP (Largest Contentful Paint)</span>
                    <p class="text-slate-400 text-xs">How long it takes for the *main* content to load. This is crucial for SEO.</p>
                </div>
            </div>
            <button onclick="closeModal('perfModal')" class="mt-6 w-full py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg transition-colors">Close</button>
        </div>
    </dialog>

    <dialog id="seoModal" class="glass-modal rounded-xl p-0 w-full max-w-lg backdrop:bg-slate-900/80 backdrop:backdrop-blur-sm shadow-2xl">
        <div class="p-6">
            <h3 class="text-xl font-bold text-white mb-4">SEO Score</h3>
            <p class="text-slate-400 text-sm mb-4">Checks if your page is optimized for search engine ranking.</p>
            <ul class="list-disc pl-5 text-slate-400 text-sm space-y-1">
                <li>Has a valid <code>&lt;title&gt;</code> and meta description.</li>
                <li>Uses legible font sizes for mobile.</li>
                <li>Links have descriptive text.</li>
                <li>Page is crawlable (not blocked by robots.txt).</li>
            </ul>
            <button onclick="closeModal('seoModal')" class="mt-6 w-full py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg transition-colors">Close</button>
        </div>
    </dialog>

    <dialog id="techModal" class="glass-modal rounded-xl p-0 w-full max-w-lg backdrop:bg-slate-900/80 backdrop:backdrop-blur-sm shadow-2xl">
        <div class="p-6">
            <h3 class="text-xl font-bold text-white mb-4">Technology Stack</h3>
            <p class="text-slate-400 text-sm mb-4">We use <strong>Wappalyzer</strong> logic to identify CMSs, web servers, frameworks, analytics tools, and libraries running on the site.</p>
            <div class="bg-blue-900/20 p-4 rounded-lg border border-blue-500/20 text-sm">
                <h4 class="font-bold text-blue-400 mb-1">Security Note</h4>
                <p class="text-slate-400">Revealing detailed version numbers (e.g., "Nginx 1.18.0") can help attackers find specific vulnerabilities (CVEs). It is best practice to hide version numbers in production.</p>
            </div>
            <button onclick="closeModal('techModal')" class="mt-6 w-full py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg transition-colors">Close</button>
        </div>
    </dialog>

    <script>
        document.getElementById("year").innerText = new Date().getFullYear();
        let pollInterval;
        let currentData = {}; 

        async function startScan() {
            const domain = document.getElementById('domainInput').value.trim();
            if(!domain) return;

            // UI Reset
            document.getElementById('scanBtn').innerHTML = `<svg class="animate-spin h-4 w-4 text-white" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('resultsArea').classList.add('hidden');
            document.getElementById('errorMsg').classList.add('hidden');
            
            try {
                const res = await fetch('/api/scan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ domain })
                });
                
                const data = await res.json();
                if(data.error) throw new Error(data.error);

                currentData = data.tier1; // Store for modals
                renderTier1(data.tier1);
                
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('resultsArea').classList.remove('hidden');
                document.getElementById('scanBtn').innerText = 'Scan';
                
                // Set Up Deep Scan "Terminal"
                document.getElementById('deepScanStatus').innerText = 'Running...';
                document.getElementById('deepScanStatus').className = "px-2 py-1 rounded text-xs font-bold bg-blue-500/20 text-blue-400 border border-blue-500/20 animate-pulse";
                document.getElementById('tier2Loading').classList.remove('hidden');
                document.getElementById('tier2Results').classList.add('hidden');
                document.getElementById('screenshotContainer').classList.add('hidden');
                
                // Update screenshot link immediately
                document.getElementById('screenshotLink').href = `https://${domain}`;

                // Reset Terminal
                const terminal = document.getElementById('scanTerminal');
                terminal.innerHTML = `
                    <div class="text-slate-500 mb-1">$ init wiredalter-scanner --deep --target=${domain}</div>
                    <div class="text-blue-400 mb-1">> Spawning Headless Chrome... [OK]</div>
                `;

                pollDeepScan(data.id);

            } catch (err) {
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('errorMsg').innerText = err.message;
                document.getElementById('errorMsg').classList.remove('hidden');
                document.getElementById('scanBtn').innerText = 'Scan';
            }
        }

        function renderTier1(data) {
            // SSL
            const sslEl = document.getElementById('sslStatus');
            const sslDet = document.getElementById('sslDetail');
            if(data.ssl.valid) {
                sslEl.innerHTML = `<span class="text-emerald-400">Valid</span>`;
                sslDet.innerText = `Expires in ${data.ssl.daysRemaining} days`;
            } else {
                sslEl.innerHTML = `<span class="text-red-400">Invalid</span>`;
                sslDet.innerText = data.ssl.error || 'Certificate Error';
            }

            // Headers
            const gradeEl = document.getElementById('headerGrade');
            gradeEl.innerText = data.headers.grade;
            gradeEl.className = `text-4xl font-bold ${data.headers.grade === 'A' ? 'text-emerald-400' : (data.headers.grade === 'F' ? 'text-red-500' : 'text-yellow-400')}`;
            document.getElementById('headerServer').innerText = data.headers.server;

            // Ports
            const portsEl = document.getElementById('portsStatus');
            if(data.ports.open && data.ports.open.length > 0) {
                portsEl.innerHTML = `<span class="text-yellow-400">${data.ports.open.length} Ports Open</span>`;
            } else {
                portsEl.innerHTML = `<span class="text-emerald-400">All Common Closed</span>`;
            }

            // Carbon
            document.getElementById('carbonAmount').innerText = `${data.carbon.co2}g`;
            document.getElementById('carbonGreen').innerHTML = data.carbon.green ? 
                `<span class="text-emerald-400">ðŸŒ± Green Hosting</span>` : 
                `<span class="text-slate-500">Standard Hosting</span>`;
        }

        // Simulates a terminal output to make waiting less boring
        function addTerminalLog(msg) {
            const terminal = document.getElementById('scanTerminal');
            terminal.innerHTML += `<div class="text-emerald-400 mb-1">> ${msg}</div>`;
            terminal.scrollTop = terminal.scrollHeight;
        }

        async function pollDeepScan(id) {
            let ticks = 0;
            clearInterval(pollInterval);
            
            pollInterval = setInterval(async () => {
                ticks++;
                // Add fake logs to keep it interesting
                if(ticks === 2) addTerminalLog("Analyzing Document Object Model (DOM)...");
                if(ticks === 4) addTerminalLog("Running Lighthouse Audits (Perf, SEO)...");
                if(ticks === 6) addTerminalLog("Fingerprinting Tech Stack (Wappalyzer)...");

                const res = await fetch(`/api/scan/${id}`);
                const job = await res.json();

                if (job.state === 'completed') {
                    clearInterval(pollInterval);
                    addTerminalLog("Analysis Complete. Rendering Report...");
                    setTimeout(() => renderTier2(job.result), 500); // Small delay for effect
                } else if (job.state === 'failed') {
                    clearInterval(pollInterval);
                    document.getElementById('deepScanStatus').innerText = 'Failed';
                    document.getElementById('deepScanStatus').className = "px-2 py-1 rounded text-xs font-bold bg-red-500/20 text-red-400 border border-red-500/20";
                    document.getElementById('tier2Loading').innerHTML = `<span class="text-red-400">Scan Failed: ${job.error}</span>`;
                }
            }, 1000);
        }

        function renderTier2(data) {
            document.getElementById('deepScanStatus').innerText = 'Complete';
            document.getElementById('deepScanStatus').className = "px-2 py-1 rounded text-xs font-bold bg-emerald-500/20 text-emerald-400 border border-emerald-500/20";
            
            document.getElementById('tier2Loading').classList.add('hidden');
            document.getElementById('tier2Results').classList.remove('hidden');

            renderGauge('perfGauge', data.performance, document.getElementById('perfScore'));
            renderGauge('seoGauge', data.seo, document.getElementById('seoScore'));

            const techList = document.getElementById('techStackList');
            techList.innerHTML = '';
            if(data.tech && data.tech.length > 0) {
                data.tech.forEach(t => {
                    techList.innerHTML += `<span class="px-2 py-1 rounded-md bg-slate-800 border border-slate-700 text-xs text-slate-300 font-mono">${t.name}</span>`;
                });
            } else {
                techList.innerHTML = `<span class="text-slate-500 text-xs">No specific technologies detected.</span>`;
            }

            if(data.screenshot) {
                document.getElementById('screenshotContainer').classList.remove('hidden');
                document.getElementById('screenshotImg').src = data.screenshot;
            }
        }

        function renderGauge(elementId, score, textElement) {
            const color = score >= 90 ? '#34d399' : (score >= 50 ? '#fbbf24' : '#ef4444');
            const circumference = 2 * Math.PI * 45;
            const offset = circumference - (score / 100) * circumference;
            
            document.getElementById(elementId).innerHTML = `
                <svg viewBox="0 0 100 100" class="w-full h-full">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#1e293b" stroke-width="8" />
                    <circle cx="50" cy="50" r="45" fill="none" stroke="${color}" stroke-width="8" 
                            stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
                            class="circle-chart__circle" stroke-linecap="round" />
                </svg>
            `;
            textElement.innerText = Math.round(score);
            textElement.style.color = color;
        }

        // --- MODAL LOGIC ---
        function showModal(id) {
            const modal = document.getElementById(id);
            if(id === 'sslModal') {
                const d = currentData.ssl;
                document.getElementById('sslModalContent').innerHTML = `
                    <div class="grid grid-cols-2 gap-2">
                        <span class="text-slate-500">Status:</span> <span>${d.valid ? 'Valid' : 'Invalid'}</span>
                        <span class="text-slate-500">Issuer:</span> <span>${d.issuer}</span>
                        <span class="text-slate-500">Valid From:</span> <span>${d.validFrom ? new Date(d.validFrom).toLocaleDateString() : '-'}</span>
                        <span class="text-slate-500">Expires:</span> <span>${d.validTo ? new Date(d.validTo).toLocaleDateString() : '-'}</span>
                    </div>
                `;
            }
            if(id === 'headersModal') {
                const d = currentData.headers;
                let html = `<div class="mb-4 text-xs font-mono bg-slate-900 p-2 rounded">Server: ${d.server}</div>`;
                if(d.missing && d.missing.length > 0) {
                    html += `<p class="text-red-400 text-xs font-bold mb-2">Missing Recommended Headers:</p>`;
                    d.missing.forEach(m => html += `<div class="text-red-300 text-sm mb-1 flex items-center gap-2"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg> ${m}</div>`);
                } else {
                    html += `<div class="text-emerald-400 text-sm flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> All core security headers are present!</div>`;
                }
                document.getElementById('headersModalContent').innerHTML = html;
            }
            if(id === 'portsModal') {
                const d = currentData.ports;
                let html = '';
                if(d.open && d.open.length > 0) {
                    d.open.forEach(p => {
                        html += `<div class="flex justify-between bg-slate-900 p-2 rounded mb-2 border border-red-900/30">
                            <span class="text-white font-mono">Port ${p}</span>
                            <span class="text-red-400 text-xs uppercase font-bold">Open</span>
                        </div>`;
                    });
                } else {
                    html = `<div class="text-emerald-400 text-sm">No common ports found open (21, 22, 80, 443, 8080). This is good for security (stealth).</div>`;
                }
                document.getElementById('portsModalContent').innerHTML = html;
            }
            modal.showModal();
        }

        function closeModal(id) { document.getElementById(id).close(); }
        document.querySelectorAll('dialog').forEach(dialog => {
            dialog.addEventListener('click', (event) => {
                if (event.target === dialog) dialog.close();
            });
        });
    </script>
</body>
</html>
